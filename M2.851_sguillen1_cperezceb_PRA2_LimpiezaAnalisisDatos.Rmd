---
title: ''
date: " "
output:
  html_document:
    highlight: default
    number_sections: no
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: M2.851_Header.html
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=T, echo=T)
```

******
# Recursos
******

El desarrollo de la práctica se fundamenta con el material didáctico visto durante el curso:

* Calvo M., Subirats L., Pérez D. (2019). Introducción a la limpieza y análisis de los datos. Editorial UOC.
*  Megan Squire (2015). Clean Data. Packt Publishing Ltd

El conjunto de datos utilizado está publicado en el repositorio Kaggle y accesible a través de la siguiente url:

* [Titanic: Machine Learning from Disaster.](https://www.kaggle.com/c/titanic "Titanic Dataset")

******
# Objetivo y presentación del caso
******

La actividad se centra en el tratamiento de un dataset. En primer lugar, tendremos una fase de estudio previo para conocer cómo son nuestros datos, su estructura y su comportamiento. Una segunda fase de preparación, dónde aplicaremos la técnicas necesarias para la adecuación de los datos para la siguiente fase de análisis y, finalmente, y extraeremos conclusiones.

El dataset elegido tiene información sobre los pasajeros que viajaba abordo del Titanic. Como se detalla en el link de Kaggle, el dataset corresponde a una competición activa donde se debe desarrollar un modelo capaz de predecir la supervivencia de los pasajeros. Por ello, disponemos de tres datasets:

* train.csv que sería el conjunto de datos para diseñar nuestro algoritmo, el cual dispone de la variable _Survived_ que identifica si sobrevivió o no al hundimiento.
* test.csv que sirve para validar la calidad de nuestro modelo.
* gender_submission.csv que identifica la supervivencia de cada uno de los pasajeros.


# Análisis inicial y exploración de los datos

Esta fase inicial tiene como objetivo conocer profundamente los datos tanto en su formato como contenido.
Empezamos haciendo un breve revisión del dataset _train_; número de registros, tipos de datos, distribuciones de las variables..

Para ello cargamos de los datos del fichero train.csv en la variable _data_:

```{r message= FALSE, warning=FALSE}
data<-read.csv("./data/train.csv",header=T,sep=",")
attach(data)
```
***

**NOTA:** ¿se deberían juntar los dos dataset? No se va crear un modelo de predicción

***

¿Qué variables componen nuestro dataset?

```{r}
str(data)
```

Disponemos de un total de 891 muestras y 12 variables distintas; 5 de tipo carácter, 5 de tipo integer y 2 numéricas.

Las variables del conjunto de datos son:

+ **PassengerId**: Identificador del pasajero o tripulante.
+ **Survived**: Varible que identifica si sobrevive o no al hundimiento. Valores posibles: "0-Fallece", "1-Sobrevive"
+ **Pclass**: hace referencia a la clase en la que viajaban los pasajeros (1ª, 2ª, 3ª).
+ **Name**: Nombre del pasajero.
+ **Sex**: Género del individuo. Valores posibles: male, female.
+ **Age**: Edad del individuo.
+ **SibSp**: Hermanos/as y conyuges a bordo.
+ **Parch**: Padres e hijos.
+ **Ticket**: Número de billete.
+ **Fare**: Tarifa del billete.
+ **Cabin**: Número de cabina.
+ **Embarked**: Puerto de embarque. Valores posibles: "C = Cherbourg", "Q = Queenstown" o "S = Southampton"

Factorizamos la variable _Sex_ y la variable _Embarked_
```{r}
data$Sex <- as.factor(data$Sex)
data$Embarked <- as.factor(data$Embarked)
```

y categorizamos las variables numéricas, _Age_ y _Fare_, en rangos/tramos de valores

```{r}
data["Age"] <- cut(data$Age, breaks = c(0,20,40,60,80,100), labels = c("0-19", "20-39","40-59","60-79",">79"))
data$Age <- as.factor(data$Age)

data["Fare"] <- cut(data$Fare, breaks = c(0,10,20,30,40,50,60,70,100), labels = c("0-9", "10-19", "20-29", "30-39","40-49","50-59","60-69","70-79"))
data$Fare <- as.factor(data$Fare)
```

Transformamos los valores de la varible _Survived_ para que sea "S" para los supervivientes y "N" para identificar los no supervivientes
```{r}
data$Survived[data$Survived == 1]<-'S'
data$Survived[data$Survived == 0]<-'N'
data$Survived <- as.factor(data$Survived)
```

Veamos algunas métricas de estas variables, sus valores máximos, mínimos, medias...

```{r}
summary(data)
```

A priori, podemos descartar las variables _Ticket_, _Name_ y _PassengerId_  ya que no van a formar parte de nuestros análisis y, de esta forma, utilizaremos un conjunto de datos menor.

```{r}
data$Name<-NULL
data$Ticket<-NULL
data$PassengerId<-NULL
```

Basándonos en las anteriores métricas ya podemos extraer algunas conclusiones:

* Hay un pequeño porcentaje de supervivientes.
* La mayoría de los pasajeros viajan en tercera clase.
* En general son personas adultas entre 20 y 38 años pero hay muchos valores desconocidos
* ¿Viajan solos?
* El coste del pasaje más habitual de 14.45, siendo el más caro de 512.33
* En la muestra hay muchos más varones que mujeres, 577 y 344 respectivamente.
* La mayoría de los pasajeros partieron de Southampton



Utilizaremos gráficos para la representación de los datos y así aportar un mayor enriquecimiento del conocimiento sobre ellos.

Requeriremos de los paquetes ggplot2, gridExtra y grid de R. 

```{r echo=FALSE, message= FALSE, warning=FALSE}

if(!require(ggplot2)){
    install.packages('ggplot2', repos='http://cran.us.r-project.org')
    library(ggplot2)
}

if(!require(grid)){
    install.packages('grid', repos='http://cran.us.r-project.org')
    library(grid)
}
if(!require(gridExtra)){
    install.packages('gridExtra', repos='http://cran.us.r-project.org')
    library(gridExtra)
}

```

***

**NOTA:** Igual deberíamos tratar los datos vacíos y outlier en este punto, antes de seguir

***


## Distribución de las variables

Representamos la distribución de las variables y donde se ve reflejado las afirmaciones extraídas sobre los datos anteriores.  


```{r echo=FALSE, message=FALSE, warning=FALSE}
grid.newpage()

  plotbyClass<-ggplot(data,aes(Pclass))+geom_bar(fill = "#377EB8") +labs(x="", y="Pasajeros")+ggtitle("Clase")
  plotbySex<-ggplot(data,aes(Sex))+geom_bar(fill = "#377EB8") +labs(x="", y="Pasajeros")+ggtitle("Género")
  
grid.arrange(plotbyClass, plotbySex,ncol=2)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
grid.newpage()
 
  plotbyAge<-ggplot(data,aes(Age))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("Edad")
  plotbyFare<-ggplot(data,aes(Fare))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("Fare")
  
grid.arrange(plotbyAge, plotbyFare,ncol=2)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
grid.newpage()
 
  plotbySibSp<-ggplot(data,aes(SibSp))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("SibSp")
  plotbyParch<-ggplot(data,aes(Parch))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("Parch")
  
grid.arrange(plotbySibSp, plotbyParch,ncol=2)

```

A continuación, se muestra la distribución de la varible supervivencia, que además, nos interesa describir su relación con el resto de variables. 

```{r}
 ggplot(data,aes(Survived))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("Superviviente")
```

Para ello, por un lado graficaremos mediante diagramas de barras la cantidad de muertos y supervivientes según la clase en la que viajaban, la edad, género, si viajan con familia, de donde embarcaron o el precio del billete. 

Por otro lado, para obtener los datos que estamos graficando utilizaremos el comando table para dos variables que nos proporciona una tabla de contingencia.

## Relación con la variable supervivencia {.tabset}

De estos gráficos obtenemos información muy valiosa que complementamos con las tablas de contingencia (listadas abajo). 

Por un lado, sobrevivieron un mayor número de mujeres que de hombre, hombres: 109 y mujeres 233 y el porcentaje de supervivencia en el caso de las mujeres se situa entorno al 74%, mientras que la de los hombres es del 18.89%, por lo tanto, la tasa de muerte en hombres es muchísimo mayor 81%. 

En cuanto a la clase en la que viajaban, los pasajeros que viajaban en primera clase fueron los únicos que el porcentaje de supervivencia era mayor que el de mortalidad. El 62,96% de los viajeros de primera clase sobrevivió, el 47,3% de los que viajaban en segunda clase mientras que de los viajeros de tercera solo sobrevivieron un 24,23%. 

Aunque el grupo de menores es pequeño son los que mayor porcentaje de supervivencia presentan, manteniendose este comportamiento en cada una de la clases.

### Pclass {-}

```{r, fig.width=12, fig.height=5}
ggplot(data,aes(Pclass,fill=Survived))+geom_bar() +labs(x="Clase", y="Pasajeros")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("black","#008000"))+ggtitle("Superviviente por clase")
```

```{r}
tablaClass <- table(Pclass,Survived)
tablaClass
prop.table(tablaClass, margin = 1)
```


### Age {-}

```{r, fig.width=12, fig.height=5}

ggplot(data,aes(Age,fill=Survived))+geom_bar() +labs(x="Edad", y="Pasajeros")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("black","#008000"))+ggtitle("Superviviente por edad")

```

```{r}
ggplot(data,aes(x=Age,fill=Survived))+geom_bar(position="fill")+facet_wrap(~Pclass)+ggtitle("Pasajeros por edad y clase con relación con la supervivencia")
```


```{r}
tablaAge <- table(Age, Survived)
tablaAge
prop.table(tablaAge, margin = 1)
```

### Sex {-}

```{r, fig.width=12, fig.height=5}

ggplot(data,aes(Sex,fill=Survived))+geom_bar() +labs(x="Sexo", y="Pasajeros")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("black","#008000"))+ggtitle("Superviviente por sexo")

```

```{r}
tablaSex <- table(Sex, Survived)
tablaSex
prop.table(tablaSex, margin = 1)
```


## Correlación de variables


## Test estadísticos de significancia

Los resultados anteriores muestran los datos de forma descriptiva, podemos añadir algún test estadístico para validar el grado de significancia de la relación. La librería "DescTools" nos permite instalarlo fácilmente.


```{r}
if(!require(DescTools)){
    install.packages('DescTools', repos='http://cran.us.r-project.org')
    library(DescTools)
}
```

```{r}
Phi(tablaClass) 
CramerV(tablaClass) 
```

```{r}
Phi(tablaSex) 
CramerV(tablaSex) 
```

```{r}
Phi(tablaAge) 
CramerV(tablaAge) 
```

Valores de la V de Cramér  (https://en.wikipedia.org/wiki/Cramér%27s_V) y Phi (https://en.wikipedia.org/wiki/Phi_coefficient) entre 0.1 y 0.3 nos indican que la asociación estadística es baja, y entre 0.3 y 0.5 se puede considerar una asociación media. Finalmente, si los valores fueran superiores a 0.5 (no es el caso), la asociación estadística entre las variables sería alta.
Como se puede apreciar, los valores de Phi y V coinciden. Esto ocurre en el contexto de analizar tablas de contingencia 2x2.

Una alternativa interesante a las barras de diagramas, es el plot de las tablas de contingencia. Obtenemos la misma información pero para algunos receptores puede resultar más visual.  

```{r}
par(mfrow=c(2,2))
plot(tablaClass, col = c("black","#008000"), main = "SURVIVED vs. CLASS")
plot(tablaAge, col = c("black","#008000"), main = "SURVIVED vs. AGE")
plot(tablaSex, col = c("black","#008000"), main = "SURVIVED vs. SEX")
```

Nuestro objetivo es crear un árbol de decisión que permita analizar qué tipo de pasajero del Titanic tenía probabilidades de sobrevivir o no. Por lo tanto, la variable por la que clasificaremos es el campo de si el pasajero sobrevivió o no. De todas maneras, al imprimir las primeras (con head) y últimas 10 (con tail) filas nos damos cuenta de que los datos están ordenados.



## Valores vacios y outliers

Examinemos si hay valores missing.
En caso de haberlos, habría que tomar decisiones para tratarlos adecuadamente y en aquellos casos que el porcentaje sea muy elevado deberemos descartar la variable.

```{r}
colSums(is.na(data))
colSums(data=="")

```

