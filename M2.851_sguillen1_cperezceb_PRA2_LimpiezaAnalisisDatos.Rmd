---
title: ''
date: " "
output:
  html_document:
    highlight: default
    number_sections: no
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: M2.851_Header.html
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=T, echo=T)
```

Requeriremos de los paquetes ggplot2, gridExtra y grid de R. 

```{r echo=FALSE, message= FALSE, warning=FALSE}

if(!require(ggplot2)){
    install.packages('ggplot2', repos='http://cran.us.r-project.org')
    library(ggplot2)
}

if(!require(grid)){
    install.packages('grid', repos='http://cran.us.r-project.org')
    library(grid)
}
if(!require(gridExtra)){
    install.packages('gridExtra', repos='http://cran.us.r-project.org')
    library(gridExtra)
}

```

******
# Descripción del dataset
******

Para el desarrollo de esta práctica se ha optado por la elección del dataset: "Titanic: Machine Learning from Disaster (https://www.kaggle.com/c/titanic)". Este dataset contiene información de uno de los naufragios más conocido de la historia, donde se tienen datos relativos a sus pasajeros como edad, sexo, clase en que viajaban, ... Este dataset es muy utilizado para el entrenamiento de algoritmos, y actualmente forma parte de una competición de Kaggle. 


A partir del análisis de este dataset, se pretende averiguar si existe alguna variable que influya en la supervivencia o no.Así como conocer qué tipo de personas en bases a sus características físicas y las de su viaje tenían más probabilidades se sobrevivir.

La actividad se centra en el tratamiento de un dataset. En primer lugar, tendremos una fase de estudio previo para conocer cómo son nuestros datos, su estructura y su comportamiento. Una segunda fase de preparación, dónde aplicaremos la técnicas necesarias para la adecuación de los datos para la siguiente fase de análisis y, finalmente, y extraeremos conclusiones.


Disponemos de tres conjuntos de datos que se describen a continuación:


* train.csv: Es el que debe usarse para construir los modelos de aprendizare automático. Se porporciona el resultado de la variable _Survived_ que incida la superivivencia de cada pasajero que es sobre la que se va a llevar a cabo la práctica.

* test.csv: Es el que debe usarse para ver la precisión del modelo generado con el dataset anterior. No se proporciona la variable _Survived_.

* gender_submission.csv: Es el que contiene los valores de la variable _Survived_ para cada pasajero.


Disponemos de un total de 891 muestras y 12 variables distintas; 5 de tipo carácter, 5 de tipo integer y 2 numéricas. A continuación, se va a llevar a cabo la descripción de los atributos que forman parte del dataset:


+ **PassengerId**: Identificador del pasajero o tripulante.

+ **Survived**: Indica si el pasajero o tripulante ha sobrevivido. El valor _0_ indica que no ha sobrevivido y el _1_ que sí. Es la variable que se trata de predecir en el conjunto de test.

+ **Pclass**: Es la clase en la que ha navegado el pasajero. Existen los siguientes valores: _1_ es primera clase, _2_ es segunda clase y _3_ es tercera clase.

+ **Name**: Nombre completo del pasajero.

+ **Sex**: Género del pasajerondividuo. Existen los siguientes Valores: _male_ para hombre y _female_ para mujer.

+ **Age**: Edad en años del pasajero.

+ **SibSp**: Número de hermanos o cónyuges a bordo del barco.

+ **Parch**: Número de padres o hijos a bordo del barco.

+ **Ticket**: El indentificador del ticket.

+ **Fare**: Tarifa del billete.

+ **Cabin**: Número de cabina.

+ **Embarked**: Puerto en el que ha embarcado el pasajero. Exiten los siguientes valores: _C_ corresponde a Cherbourg, _Q_ corresponde a Queenstown y _S_ corresponde a Southampton.


******
# Integración y selección de los datos de interés a analizar.
******

# Lectura del dataset

En este aparatado se va a llevar acabo la integración y la selección de los datos que van a ser de interés para llevar a cabo el análisis.

Como se ha comentado en el apartado anterior, hay tres conjunto de datos. Cada conjunto tiene un identificador único que es la variable _PassengerId_ que permite relacionar 

```{r}
# Carga de los diferentes datasets

dataTrain<-read.csv("./data/train.csv",header=T,sep=",")
dataTest <-read.csv("./data/test.csv",header=T,sep=",")
dataReferencias <-read.csv("./data/gender_submission.csv",header=T,sep=",")


# Unimos los tres dataset en uno

dataTest <- merge(dataTest, dataReferencias, by="PassengerId")

data <- rbind(dataTrain, dataTest)

```

Una vez se ha unificado los datos, se inspeccionará el conjuntos de datos: 

```{r}
# Observamos la estructura de los datos

str(data)

```

```{r}
summary(data)
```

# Selección de datos

En el siguiente paso se eliminaran aquellas columnas que no contengan información útil para el desarrollo de esta práctica.

```{r}
# Eliminamos las columnas

data <- subset(data, select = -c(PassengerId, Ticket, Cabin))

```


******
# Limpieza de los datos.
******

# Varible _Name_

En primer lugar analizaremos la variables _Name_:

```{r}
data$Title <- gsub('(.*, )|(\\..*)', '', data$Name)
rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don',
'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')
data$Title[data$Title == 'Mlle'] <- 'Miss'
data$Title[data$Title == 'Ms'] <- 'Miss'
data$Title[data$Title == 'Mme'] <- 'Mrs'
data$Title[data$Title %in% rare_title] <- 'Rare Title'
data$Title <- as.factor(data$Title)
data$Surname <- sapply(data$Name,
function(x) strsplit(x, split = '[,.]')[[1]][1])

data$Surname <- as.factor(data$Surname)
```


# Variable _SibSp_ y _Parch_

En este apartado se combinarán la variables _SibSp_ y _Parch_ para crear una nueva variables llamada _Famsize_.

```{r}

data$Famsize <- data$SibSp + data$Parch + 1
```

```{r}

data$Fsize[data$Famsize == 1] <- 'singleton'
data$Fsize[data$Famsize < 5 & data$Famsize > 1] <- 'small'
data$Fsize[data$Famsize > 4] <- 'large'

data$Fsize <- as.factor(data$Fsize)


mosaicplot(table(data$Famsize, data$Survived), main='Family Size by Survival', shade=TRUE)
```



# Variable _Survived_


En primer lugar se convertirán a factores las variables _Survived_, _PClass_, _Sex_ y _Embarked_.

```{r}

data$Survived <- as.factor(data$Survived)


```


# Variable _PClass_

```{r}
data$Pclass <- as.factor(data$Pclass)

```




# Variable _Sex_

```{r}
data$Sex <- as.factor(data$Sex)

```





# Variable _Embarked_



```{r}
data$Embarked <- as.factor(data$Embarked)


```



# Variable _Fare_


```{r}

```




## Valores vacios y outliers

En este apartado se analizará si las variables contienen valores nulos o incompletos.

```{r}
col_mis <- colSums(is.na(data) | data=="")
print(col_mis)

```

A continuación se trataran las variables con valores nulos o incompletos.

# Variable _Age_



```{r}



```




# Varible _Fare_

Antes de imputar los valores perdidos de la varible _Fare_ se comprobará las características de estos valores.

```{r}

miss_fare_index <- which(is.na(data$Fare))
miss_fare <- data[miss_fare_index,]
miss_fare

```


Se visualiza los valores de la variable _Fare_ para los otros pasajeros que comparten los mismo valores para las variables _PClass_ y _Embarked_. 


```{r}

ggplot(data[data$Pclass == '3' & data$Embarked == 'S',],
       aes(x = Fare)) +
  geom_density(fill = '#99d6ff', alpha=0.4) +
  geom_vline(aes(xintercept=median(Fare, na.rm=T)),
             colour='red', linetype='dashed', lwd=1) +
  scale_x_continuous(labels=dollar_format()) +
  theme_few()
```


Después de visualizar las gráfica anterior se puede dar por válido el reemplezar el valor perdido de la variable _Fare_  por la mediana de su clase y embarque.


```{r}
data$Fare[1044] <- median(data[data$Pclass == '3' & data$Embarked == 'S', ]$Fare, na.rm = TRUE)

```



# variable _Embarked_

Antes de imputar los valores perdidos de la variable _Embarked_ se comprobará las características de estos valores.

```{r}

miss_embark_index <- which(is.na(data$Embarked))
miss_embark <- data[miss_embark_index,]
miss_embark

```


Se visualiza los valores de la variable _Fare_ para los otros pasajeros que comparten los mismo valores para las variables _PClass_ y _Fare_.

```{r}


ggplot(data[!is.na(data$Embarked),], aes(x = Embarked, y = Fare, fill = factor(Pclass))) +
  geom_boxplot() +
  geom_hline(aes(yintercept=80),
             colour='red', linetype='dashed', lwd=2) +
  scale_y_continuous(labels=dollar_format()) +
  theme_few()
```

Después de visualizar las gráfica anterior se puede dar por válido el reemplezar el valor perdido de la variable _Embarked_  por el valor _C_.

```{r}

data$Embarked[miss_embark_index] <- 'C'

```

## valores extremos


En este apartado se analizarán los valores extremos de las variables _Age_, _Fare_, _SibSp_, _Parch_ y _Fsize_.

# variable _Age_

```{r}
boxplot(data$Age, main="Box plot", col="gray")

```


Se puede observar que los valores extremos están en un rango normal, ningún pasajero es menor que 0 o mayor que 100.


# Variable _Fare_

```{r}

boxplot(data$Fare, main="Box plot", col="gray")
```

```{r}

ggplot(data, aes(x = Pclass, y = Fare)) +
  geom_boxplot() +
  geom_hline(aes(yintercept=80),
             colour='red', linetype='dashed', lwd=2) +
  scale_y_continuous(labels=dollar_format()) +
  theme_few()

```


# Variable _SibSp_

```{r}

boxplot(data$SibSp, main="Box plot", col="gray")
```

# Variable _Parch_

```{r}
boxplot(data$Parch, main="Box plot", col="gray")

```




## Distribución de las variables

Representamos la distribución de las variables y donde se ve reflejado las afirmaciones extraídas sobre los datos anteriores.  


```{r echo=FALSE, message=FALSE, warning=FALSE}
grid.newpage()

  plotbyClass<-ggplot(data,aes(Pclass))+geom_bar(fill = "#377EB8") +labs(x="", y="Pasajeros")+ggtitle("Clase")
  plotbySex<-ggplot(data,aes(Sex))+geom_bar(fill = "#377EB8") +labs(x="", y="Pasajeros")+ggtitle("Género")
  
grid.arrange(plotbyClass, plotbySex,ncol=2)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
grid.newpage()
 
  plotbyAge<-ggplot(data,aes(Age))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("Edad")
  plotbyFare<-ggplot(data,aes(Fare))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("Fare")
  
grid.arrange(plotbyAge, plotbyFare,ncol=2)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
grid.newpage()
 
  plotbySibSp<-ggplot(data,aes(SibSp))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("SibSp")
  plotbyParch<-ggplot(data,aes(Parch))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("Parch")
  
grid.arrange(plotbySibSp, plotbyParch,ncol=2)

```

A continuación, se muestra la distribución de la varible supervivencia, que además, nos interesa describir su relación con el resto de variables. 

```{r}
 ggplot(data,aes(Survived))+geom_bar(fill = "#377EB8") +labs(x="", y="")+ggtitle("Superviviente")
```

Para ello, por un lado graficaremos mediante diagramas de barras la cantidad de muertos y supervivientes según la clase en la que viajaban, la edad, género, si viajan con familia, de donde embarcaron o el precio del billete. 

Por otro lado, para obtener los datos que estamos graficando utilizaremos el comando table para dos variables que nos proporciona una tabla de contingencia.

## Relación con la variable supervivencia {.tabset}

De estos gráficos obtenemos información muy valiosa que complementamos con las tablas de contingencia (listadas abajo). 

Por un lado, sobrevivieron un mayor número de mujeres que de hombre, hombres: 109 y mujeres 233 y el porcentaje de supervivencia en el caso de las mujeres se situa entorno al 74%, mientras que la de los hombres es del 18.89%, por lo tanto, la tasa de muerte en hombres es muchísimo mayor 81%. 

En cuanto a la clase en la que viajaban, los pasajeros que viajaban en primera clase fueron los únicos que el porcentaje de supervivencia era mayor que el de mortalidad. El 62,96% de los viajeros de primera clase sobrevivió, el 47,3% de los que viajaban en segunda clase mientras que de los viajeros de tercera solo sobrevivieron un 24,23%. 

Aunque el grupo de menores es pequeño son los que mayor porcentaje de supervivencia presentan, manteniendose este comportamiento en cada una de la clases.

### Pclass {-}

```{r, fig.width=12, fig.height=5}
ggplot(data,aes(Pclass,fill=Survived))+geom_bar() +labs(x="Clase", y="Pasajeros")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("black","#008000"))+ggtitle("Superviviente por clase")
```

```{r}
tablaClass <- table(Pclass,Survived)
tablaClass
prop.table(tablaClass, margin = 1)
```


### Age {-}

```{r, fig.width=12, fig.height=5}

ggplot(data,aes(Age,fill=Survived))+geom_bar() +labs(x="Edad", y="Pasajeros")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("black","#008000"))+ggtitle("Superviviente por edad")

```

```{r}
ggplot(data,aes(x=Age,fill=Survived))+geom_bar(position="fill")+facet_wrap(~Pclass)+ggtitle("Pasajeros por edad y clase con relación con la supervivencia")
```


```{r}
tablaAge <- table(Age, Survived)
tablaAge
prop.table(tablaAge, margin = 1)
```

### Sex {-}

```{r, fig.width=12, fig.height=5}

ggplot(data,aes(Sex,fill=Survived))+geom_bar() +labs(x="Sexo", y="Pasajeros")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("black","#008000"))+ggtitle("Superviviente por sexo")

```

```{r}
tablaSex <- table(Sex, Survived)
tablaSex
prop.table(tablaSex, margin = 1)
```


## Correlación de variables


## Test estadísticos de significancia

Los resultados anteriores muestran los datos de forma descriptiva, podemos añadir algún test estadístico para validar el grado de significancia de la relación. La librería "DescTools" nos permite instalarlo fácilmente.


```{r}
if(!require(DescTools)){
    install.packages('DescTools', repos='http://cran.us.r-project.org')
    library(DescTools)
}
```

```{r}
Phi(tablaClass) 
CramerV(tablaClass) 
```

```{r}
Phi(tablaSex) 
CramerV(tablaSex) 
```

```{r}
Phi(tablaAge) 
CramerV(tablaAge) 
```

Valores de la V de Cramér  (https://en.wikipedia.org/wiki/Cramér%27s_V) y Phi (https://en.wikipedia.org/wiki/Phi_coefficient) entre 0.1 y 0.3 nos indican que la asociación estadística es baja, y entre 0.3 y 0.5 se puede considerar una asociación media. Finalmente, si los valores fueran superiores a 0.5 (no es el caso), la asociación estadística entre las variables sería alta.
Como se puede apreciar, los valores de Phi y V coinciden. Esto ocurre en el contexto de analizar tablas de contingencia 2x2.

Una alternativa interesante a las barras de diagramas, es el plot de las tablas de contingencia. Obtenemos la misma información pero para algunos receptores puede resultar más visual.  

```{r}
par(mfrow=c(2,2))
plot(tablaClass, col = c("black","#008000"), main = "SURVIVED vs. CLASS")
plot(tablaAge, col = c("black","#008000"), main = "SURVIVED vs. AGE")
plot(tablaSex, col = c("black","#008000"), main = "SURVIVED vs. SEX")
```

Nuestro objetivo es crear un árbol de decisión que permita analizar qué tipo de pasajero del Titanic tenía probabilidades de sobrevivir o no. Por lo tanto, la variable por la que clasificaremos es el campo de si el pasajero sobrevivió o no. De todas maneras, al imprimir las primeras (con head) y últimas 10 (con tail) filas nos damos cuenta de que los datos están ordenados.




******
# Recursos
******


*  Calvo M., Subirats L., Pérez D. (2019). Introducción a la limpieza y análisis de los datos. Editorial UOC.

*  Megan Squire (2015). Clean Data. Packt Publishing Ltd

*  Ramos Lorenzo, C. (2019). RPubs - Logistic Regressión. https://rpubs.com/MrCristianrl/500969
